#!/bin/bash

# Configuration variables
CONTAINER_NAME="u22.04"
IMAGE_NAME="u22.04"
CONTAINER_USER_DIR="/home/user/"
CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Script paths
BUILD_SCRIPT="${CURRENT_DIR}/build.sh"
RUN_SCRIPT="${CURRENT_DIR}/run.sh"
CONNECT_SCRIPT="${CURRENT_DIR}/connct.sh"

function build() {
    echo "Building Docker image '${IMAGE_NAME}'..."
    docker build . -t ${IMAGE_NAME} -f "${CURRENT_DIR}/Dockerfile"
}


function run() {
    echo "Running Docker container '${CONTAINER_NAME}'..."
    if docker ps -a -q -f name="^/${CONTAINER_NAME}$" >/dev/null; then
        echo "Removing existing container '${CONTAINER_NAME}'..."
        docker rm -f "${CONTAINER_NAME}"
    fi
    docker run -t -d -p 6000:6000 --name=${CONTAINER_NAME} ${IMAGE_NAME} /bin/bash -c "while true; do sleep 30; done"
}

function connect() {
    echo "Connecting to Docker container '${CONTAINER_NAME}'..."
    docker exec -it -u 0 "${CONTAINER_NAME}" tmux
}

function upload() {
    local source_path="$1"
    
    if [ -z "${source_path}" ]; then
        echo "Error: Please specify a folder or file to upload."
        echo "Usage: $0 upload <folderorfilepath>"
        exit 1
    fi

    # Convert to absolute path if relative
    if [[ ! "${source_path}" = /* ]]; then
        source_path="$(pwd)/${source_path}"
    fi

    if [ ! -e "${source_path}" ]; then
        echo "Error: The specified file or folder does not exist: ${source_path}"
        exit 1
    fi

    echo "Uploading '${source_path}' to container '${CONTAINER_NAME}:${CONTAINER_USER_DIR}'..."
    docker cp "${source_path}" "${CONTAINER_NAME}:${CONTAINER_USER_DIR}"
    
    if [ $? -eq 0 ]; then
        echo "Upload completed successfully."
    else
        echo "Error: Upload failed."
        exit 1
    fi
}

# Main script logic
if [ "$#" -eq 0 ]; then
    echo "Usage: $0 {build|run|connect|upload <folderorfilepath>}"
    echo ""
    echo "Commands:"
    echo "  build   - Build the Docker image"
    echo "  run     - Run the Docker container"
    echo "  connect - Connect to the running container"
    echo "  upload  - Upload file/folder to container"
    exit 1
fi

case "$1" in
    build)
        build
        ;;
    run)
        run
        ;;
    connect)
        connect
        ;;
    upload)
        upload "$2"
        ;;
    *)
        echo "Error: Invalid option: $1"
        echo "Usage: $0 {build|run|connect|upload <folderorfilepath>}"
        exit 1
        ;;
esac